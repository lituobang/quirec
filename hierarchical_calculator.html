<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="title">研究贡献量化法计算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for academic aesthetic and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .primary { background-color: #1d4ed8; }
        .text-primary { color: #1d4ed8; }
        .bg-primary-light { background-color: #eef2ff; }
        .border-primary { border-color: #1d4ed8; }
        .tier-select:focus {
            border-color: #1d4ed8;
            box-shadow: 0 0 0 1px #1d4ed8;
        }
        .org-card {
            border-left: 4px solid #3b82f6; /* Blue 500 */
        }
        .sub-org-card {
            border-left: 2px solid #10b981; /* Emerald 500 */
        }
        .participant-card {
            border-left: 2px solid #f59e0b; /* Amber 500 */
        }
        .sticky-top-section {
            position: sticky;
            top: 2rem; 
            z-index: 10;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1d4ed8', 
                        'secondary': '#374151',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-8">
    <div class="container mx-auto max-w-7xl">
        <div class="flex justify-end mb-4">
            <select id="language-selector" class="rounded-md border border-gray-300 p-2 text-sm shadow-sm focus:ring-primary focus:border-primary">
                <option value="zh">中文 (Chinese)</option>
                <option value="en">English (中文)</option>
            </select>
        </div>

        <header class="text-center py-6 mb-8 bg-white rounded-xl shadow-lg border-t-4 border-primary">
            <h1 class="text-4xl font-bold text-secondary mb-2" data-key="header_title">研究贡献量化法计算器</h1>
            <p class="text-lg text-gray-500" data-key="header_subtitle">自加权贡献分配模型（V5.0 - CRediT三因素分档法）</p>
        </header>

        <div class="grid grid-cols-1 lg:cols-3 gap-8">

            <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-primary mb-4 border-b pb-2" data-key="section_input_title">1. 输入参与者姓名与三因素档位</h2>
                
                <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="font-bold text-secondary mb-2" data-key="mode_label">计算模式 / Calculation Mode:</p>
                    <div class="flex space-x-6">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="calcMode" value="multiply" checked onchange="updateCalculationMode('multiply')" class="form-radio text-primary h-5 w-5">
                            <span class="ml-2 text-gray-800" data-key="mode_multiply">相乘 (S × C × B) </span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="calcMode" value="add" onchange="updateCalculationMode('add')" class="form-radio text-primary h-5 w-5">
                            <span class="ml-2 text-gray-800" data-key="mode_add">累加 (S + C + B)</span>
                        </label>
                    </div>
                </div>

                <p class="text-sm text-red-500 mb-4" data-key="note_weight_removed">注意：务必确保参与者的姓名一致，否则汇总时会分开输出</p>
                
                <div id="largeOrgContainer" class="space-y-6">
                    </div>

                <button onclick="addLargeOrganization()" class="w-full mt-6 py-2 px-4 border border-primary rounded-md shadow-sm text-primary font-medium bg-white hover:bg-blue-50 transition duration-150 transform hover:scale-[1.005]" data-key="button_add_large_org">
                    + 添加大贡献项
                </button>
            </section>

            <section class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg flex flex-col h-fit sticky-top-section">
                <h2 class="text-2xl font-semibold text-primary mb-4 border-b pb-2" data-key="section_output_title">2. 计算与结果</h2>

                <button onclick="calculateContributions()" class="w-full py-3 px-4 border border-transparent rounded-md shadow-sm text-white font-medium bg-primary hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 transform hover:scale-[1.01]" data-key="button_calculate">
                    计算最终贡献比例
                </button>
                
                <div id="errorBox" class="mt-4 p-3 rounded-md bg-red-100 text-red-700 border border-red-300 hidden" data-key="error_message_validation">
                    请确保至少有两个大贡献项，且所有档位均不为零。
                </div>
                
                <div id="resultsContainer" class="mt-6 p-4 rounded-lg bg-gray-100 border-l-4 border-primary shadow-inner transition duration-300 ease-in-out hidden">
                    
                    <p class="text-lg font-semibold text-secondary mb-2" data-key="result_header_org">1. 大贡献项相对平均档位比例:</p>
                    <div id="largeOrgResults" class="space-y-2 mb-4">
                        </div>

                    <p class="text-lg font-semibold text-secondary mb-2 mt-4 border-t pt-2" data-key="result_header_participant">2. 最终参与者贡献比例 (明细):</p>
                    <div id="participantResults" class="space-y-2">
                        </div>

                    <p class="text-lg font-semibold text-secondary mb-2 mt-6 border-t-2 border-primary pt-2 bg-blue-50 p-1 rounded" data-key="result_header_aggregated">3. 最终参与者贡献比例汇总:</p>
                    <div id="participantAggregatedResults" class="space-y-2">
                        </div>
                </div>

            </section>
        </div>
        
    </div>

    <script>
        // --- Data Model and Rendering Functions ---

        let largeOrgs = []; // Global array to hold the entire hierarchical structure
        let nextParticipantId = 1000;
        let nextSmallOrgId = 100;
        let nextLargeOrgId = 1;
        let calculationMode = 'multiply'; // Default mode: 'multiply' or 'add'

        // 中文版默认结构: 中文 (English)
        const hierarchyStructureZH = {
            "组织 (Organization)": [
                "数据管理 (Data Curation)",
                "写作 - 初稿 (Writing - Original Draft)",
                "写作 - 审阅和编辑 (Writing - Review & Editing)",
                "监督，指导和管理 (Supervision)",
                "项目管理 (Project administration)"
            ],
            "技术 (Technology)": [
                "可视化 (Visualization)",
                "形式分析 (Formal analysis)",
                "确认 (Validation)",
                "软件 (Software)",
                "调查研究 (Investigation)",
                "技术类引文 (Technical References)"
            ],
            "劳动 (Labor)": [
                "调查研究 (Investigation)"
            ],
            "创新 (Innovation)": [
                "概念化 (Conceptualization)",
                "方法论 (Methodology)",
                "创新类引文 (Innovation References)"
            ],
            "外部支持 (External Support)": [
                "资金获取 (Funding acquisition)",
                "资金来源 (Funding)",
                "资源提供 (Resources)"
            ]
        };

        // 英文版默认结构: English (中文)
        const hierarchyStructureEN = {
            "Organization (组织)": [
                "Data Curation (数据管理)",
                "Writing - Original Draft (写作 - 初稿)",
                "Writing - Review & Editing (写作 - 审阅和编辑)",
                "Supervision (监督，指导和管理)",
                "Project administration (项目管理)"
            ],
            "Technology (技术)": [
                "Visualization (可视化)",
                "Formal analysis (形式分析)",
                "Validation (确认)",
                "Software (软件)",
                "Investigation (调查研究)",
                "Technical References (技术类引文)"
            ],
            "Labor (劳动)": [
                "Investigation (调查研究)"
            ],
            "Innovation (创新)": [
                "Conceptualization (概念化)",
                "Methodology (方法论)",
                "Innovation References (创新类引文)"
            ],
            "External Support (外部支持)": [
                "Funding acquisition (资金获取)",
                "Funding (资金来源)",
                "Resources (资源提供)"
            ]
        };


        const translations = {
            zh: {
                title: "研究贡献量化法 (QuIReC) 计算器",
                header_title: "研究贡献量化法 (QuIReC) 计算器",
                header_subtitle: "自加权贡献分配模型（V5.0 - CRediT三因素分档法）",
                section_input_title: "1. 输入参与者姓名与三因素档位",
                section_output_title: "2. 计算与结果",
                button_add_large_org: "+ 添加大贡献项",
                button_calculate: "计算最终贡献比例",
                error_message_validation: "请确保至少有两个大贡献项，且所有组织的档位均已计算完成，且总档位不为零。",
                result_header_org: "1. 大贡献项相对平均档位比例:",
                result_header_participant: "2. 最终参与者贡献比例 (明细):",
                result_header_aggregated: "3. 最终参与者贡献比例汇总:",
                note_weight_removed: "注意：务必确保参与者的姓名一致，否则汇总时会分开输出",
                
                large_org_name_placeholder: "大贡献项名称 (例如: 组织)",
                small_org_name_placeholder: "小贡献项名称 (例如: 数据管理)",
                participant_name_placeholder: "参与者姓名 (例如: 张三)",
                
                button_add_small_org: "+ 添加小贡献项",
                button_add_participant: "+ 添加参与者",
                button_remove: "移除",
                
                factor_scarcity: "稀缺性 (S)",
                factor_causality: "因果关系 (C)",
                factor_breakthrough: "突破性 (B)",
                
                tier_1: "一档 (1分)",
                tier_2: "二档 (2分)",
                tier_3: "三档 (3分)",
                tier_4: "四档 (4分)",
                tier_5: "五档 (5分)",
                tier_6: "六档 (6分)",
                placeholder_select: "请选择分档 (1-6)",

                large_org_score_label: "大贡献项平均档位:",
                small_org_score_label: "小贡献项平均档位:",
                button_calculate_small_org: "计算小贡献项档位",
                button_calculate_large_org: "计算大贡献项档位",
                invalid_input: "输入不完整或总档位为零",

                mode_label: "计算模式:",
                mode_multiply: "相乘 (S × C × B) ",
                mode_add: "累加 (S + C + B)",
            },
            en: {
                // Corrected English Translations & Formats
                title: "QuIReC Calculator",
                header_title: "QuIReC Calculator",
                header_subtitle: "Self-Weighted Contribution Allocation Model (V5.0 - CRediT Three-Factor Tiering Method)",
                section_input_title: "1. Input Participants and Three-Factor Tiers",
                section_output_title: "2. Calculation and Results",
                button_add_large_org: "+ Add Major Contribution Role",
                button_calculate: "Calculate Final Ratios",
                error_message_validation: "Please ensure at least two Major Roles exist, all Tiers are not zero.",
                result_header_org: "1. Major Role Relative Average Tier Ratio:",
                result_header_participant: "2. Participant Contribution Ratios (Detail):",
                result_header_aggregated: "3. Total Aggregated Contribution Summary:",
                
                note_weight_removed: "Note: Please ensure participant names are consistent; otherwise, they will be listed separately in the summary.",

                // Format: English (Chinese) for dynamic addition placeholders
                large_org_name_placeholder: "Major Role (大贡献项)", 
                small_org_name_placeholder: "Minor Role (小贡献项)", 
                participant_name_placeholder: "Participant (参与者)",
                
                button_add_small_org: "+ Add Minor Role",
                button_add_participant: "+ Add Participant",
                button_remove: "Remove",

                factor_scarcity: "Scarcity (S)",
                factor_causality: "Causality (C)",
                factor_breakthrough: "Breakthrough (B)",
                
                tier_1: "Tier 1 (1pt)",
                tier_2: "Tier 2 (2pt)",
                tier_3: "Tier 3 (3pt)",
                tier_4: "Tier 4 (4pt)",
                tier_5: "Tier 5 (5pt)",
                tier_6: "Tier 6 (6pt)",
                placeholder_select: "Select Tier (1-6)",

                large_org_score_label: "Major Role Avg Tier:",
                small_org_score_label: "Minor Role Avg Tier:",
                button_calculate_small_org: "Calc Minor Role Tier",
                button_calculate_large_org: "Calc Major Role Tier",
                invalid_input: "Incomplete input or zero tier",

                mode_label: "Calculation Mode:",
                mode_multiply: "Multiply (S × C × B)",
                mode_add: "Add (S + C + B)",
            }
        };

        function getLang() {
            return document.getElementById('language-selector')?.value || 'zh';
        }

        /**
         * Per user request, this function now always returns the full stored name, 
         * including the language translation in parentheses (e.g., "Organization (组织)").
         * @param {string} name - The stored name (e.g., "Organization (组织)").
         * @param {string} lang - The current language ('zh' or 'en').
         * @returns {string} The displayable name (always the full stored name).
         */
        function getDisplayableName(name, lang) {
            return name;
        }


        function getTierOptions() {
            const keys = translations[getLang()];
            return [
                { value: 0, text: keys.placeholder_select },
                { value: 1, text: keys.tier_1 },
                { value: 2, text: keys.tier_2 },
                { value: 3, text: keys.tier_3 },
                { value: 4, text: keys.tier_4 },
                { value: 5, text: keys.tier_5 },
                { value: 6, text: keys.tier_6 },
            ];
        }
        
        // --- Mode Update Function ---
        function updateCalculationMode(mode) {
            calculationMode = mode;
            // Clear current results display to avoid confusion
            document.getElementById('resultsContainer').classList.add('hidden');
            // Re-render hierarchy to update "Raw Score" displays
            renderHierarchy();
        }

        function createParticipantHtml(orgId, subOrgId, participant) {
            const keys = translations[getLang()];
            const factorOptions = getTierOptions();

            const createSelect = (factor) => `
                <select 
                    onchange="updateParticipantData(${orgId}, ${subOrgId}, ${participant.id}, '${factor}', this.value)"
                    id="select-${participant.id}-${factor}"
                    class="tier-select mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1 text-xs border focus:ring-primary focus:border-primary"
                >
                    ${factorOptions.map(opt => `<option value="${opt.value}" ${participant[factor] === opt.value ? 'selected' : opt.value === 0 ? 'disabled' : ''}>${opt.text}</option>`).join('')}
                </select>
            `;

            return `
                <div id="participant-${participant.id}" class="participant-card p-3 bg-white shadow-inner rounded-lg mb-2 ml-4 relative">
                    <div class="flex items-center justify-between">
                        <input type="text" value="${participant.name}" 
                            oninput="updateParticipantData(${orgId}, ${subOrgId}, ${participant.id}, 'name', this.value)"
                            placeholder="${keys.participant_name_placeholder}" 
                            class="font-medium text-secondary text-sm w-1/3 p-1 rounded-md border-gray-300 border focus:ring-primary focus:border-primary">
                        
                        <div class="flex items-center space-x-2 text-xs text-gray-500">
                            <span class="mr-4">档位（Tiers）: <strong>${getParticipantRawScore(participant)}</strong></span>
                        </div>

                        <div class="flex space-x-2">
                            <button onclick="removeParticipant(${orgId}, ${subOrgId}, ${participant.id})" class="text-red-500 hover:text-red-700 text-sm font-semibold p-1">
                                ${keys.button_remove}
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 mt-2 text-xs">
                        <div><label class="block text-gray-500">${keys.factor_scarcity}</label>${createSelect('scarcity')}</div>
                        <div><label class="block text-gray-500">${keys.factor_causality}</label>${createSelect('causality')}</div>
                        <div><div><label class="block text-gray-500">${keys.factor_breakthrough}</label>${createSelect('breakthrough')}</div></div>
                    </div>
                </div>
            `;
        }

        function createSmallOrgHtml(orgId, subOrg) {
            const keys = translations[getLang()];
            const lang = getLang(); // Get current language
            
            // Generate HTML for all participants in this small org
            const participantsHtml = subOrg.participants.map(p => createParticipantHtml(orgId, subOrg.id, p)).join('');

            // Determine initial score display based on existing data
            const scoreHtml = subOrg.weightedAverageScore > 0 
                ? `<span class="text-sm font-semibold text-emerald-700">${keys.small_org_score_label} ${subOrg.weightedAverageScore.toFixed(2)}</span>`
                : `<span class="text-gray-500 text-sm italic">(${keys.small_org_score_label} --)</span>`;

            return `
                <div id="sub-org-${subOrg.id}" class="sub-org-card p-4 bg-gray-50 rounded-xl shadow-md mb-4 ml-4">
                    <div class="flex items-center justify-between mb-3">
                        <input type="text" value="${getDisplayableName(subOrg.name, lang)}" 
                            oninput="updateSmallOrgData(${orgId}, ${subOrg.id}, 'name', this.value)"
                            placeholder="${keys.small_org_name_placeholder}" 
                            class="font-semibold text-lg text-emerald-700 w-1/3 p-1 rounded-md border-gray-300 border focus:ring-primary focus:border-primary">
                        
                        <span class="text-sm text-gray-600 italic"></span>

                        <button onclick="removeSmallOrganization(${orgId}, ${subOrg.id})" class="text-red-500 hover:text-red-700 text-sm font-semibold p-1">
                            ${keys.button_remove}
                        </button>
                    </div>

                    <div id="participants-container-${subOrg.id}">
                        ${participantsHtml}
                    </div>
                    
                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-200">
                        <button onclick="addParticipant(${orgId}, ${subOrg.id})" class="py-1 px-3 border border-dashed border-amber-500 rounded-md text-amber-600 text-sm hover:bg-amber-50 transition duration-150" data-key="button_add_participant">
                            ${keys.button_add_participant}
                        </button>
                        <button onclick="calculateSmallOrgScore(${orgId}, ${subOrg.id})" class="py-1 px-3 bg-emerald-500 text-white text-sm rounded-md shadow hover:bg-emerald-600 transition duration-150" data-key="button_calculate_small_org">
                            ${keys.button_calculate_small_org}
                        </button>
                        <div id="small-org-score-display-${subOrg.id}">
                            ${scoreHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        function createLargeOrgHtml(org) {
            const keys = translations[getLang()];
            const lang = getLang(); // Get current language
            
            // Generate HTML for all small organizations in this large org
            const smallOrgsHtml = org.smallOrgs.map(subOrg => createSmallOrgHtml(org.id, subOrg)).join('');

            // Determine initial score display based on existing data
            const scoreHtml = org.weightedAverageScore > 0 
                ? `<span class="text-base font-bold text-blue-700">${keys.large_org_score_label} ${org.weightedAverageScore.toFixed(2)}</span>`
                : `<span class="text-gray-500 text-base italic">(${keys.large_org_score_label} --)</span>`;

            return `
                <div id="large-org-${org.id}" class="org-card p-6 bg-primary-light rounded-xl shadow-xl mb-6">
                    <div class="flex items-center justify-between mb-4 pb-2 border-b border-blue-300">
                        <input type="text" value="${getDisplayableName(org.name, lang)}" 
                            oninput="updateLargeOrgData(${org.id}, 'name', this.value)"
                            placeholder="${keys.large_org_name_placeholder}" 
                            class="font-bold text-xl text-blue-700 w-2/3 p-1 rounded-md border-gray-300 border focus:ring-primary focus:border-primary">
                        
                        <button onclick="removeLargeOrganization(${org.id})" class="text-red-500 hover:text-red-700 text-sm font-semibold p-1">
                            ${keys.button_remove}
                        </button>
                    </div>

                    <div id="small-orgs-container-${org.id}">
                        ${smallOrgsHtml}
                    </div>

                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-blue-300">
                        <button onclick="addSmallOrganization(${org.id})" class="py-2 px-4 border border-dashed border-emerald-500 rounded-md text-emerald-600 font-medium hover:bg-emerald-50 transition duration-150" data-key="button_add_small_org">
                            ${keys.button_add_small_org}
                        </button>
                        <button onclick="calculateLargeOrgScore(${org.id})" class="py-2 px-4 bg-blue-500 text-white font-medium rounded-md shadow hover:bg-blue-600 transition duration-150" data-key="button_calculate_large_org">
                            ${keys.button_calculate_large_org}
                        </button>
                        <div id="large-org-score-display-${org.id}">
                            ${scoreHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHierarchy() {
            const container = document.getElementById('largeOrgContainer');
            container.innerHTML = largeOrgs.map(org => createLargeOrgHtml(org)).join('');
        }

        // --- CRUD Functions ---

        /**
         * Adds a new large organization.
         */
        function addLargeOrganization(nameOverride, smallOrgNames) {
            const keys = translations[getLang()];
            const newId = nextLargeOrgId++;
            
            // Use the base text of the placeholder for naming new items
            const baseName = keys.large_org_name_placeholder.includes('(') 
                ? keys.large_org_name_placeholder.split('(')[0].trim() 
                : keys.large_org_name_placeholder.split(' ')[0].trim();
            const defaultName = `${baseName} ${String.fromCharCode(64 + newId)}`;


            const newOrg = {
                id: newId,
                // If nameOverride exists (initial load), use the full formatted name.
                // If not (dynamic addition), use the dynamic name which is already pure.
                name: nameOverride || defaultName, 
                weightedAverageScore: 0, 
                smallOrgs: []
            };
            largeOrgs.push(newOrg);
            
            if (smallOrgNames && smallOrgNames.length > 0) {
                // Bulk add for initial setup
                smallOrgNames.forEach(smallOrgName => {
                    addSmallOrganization(newId, smallOrgName, false); 
                });
                renderHierarchy(); 
            } else {
                // Manual button click
                addSmallOrganization(newId); 
            }
        }

        function removeLargeOrganization(id) {
            largeOrgs = largeOrgs.filter(org => org.id !== id);
            renderHierarchy();
            calculateContributions();
        }
        
        function updateLargeOrgData(id, key, value) {
            const org = largeOrgs.find(o => o.id === id);
            if (org) { org[key] = value; }
            if (key === 'name') return;
            renderHierarchy();
        }

        function addSmallOrganization(orgId, nameOverride, addParticipantFlag = true) {
            const org = largeOrgs.find(o => o.id === orgId);
            if (!org) return;

            const keys = translations[getLang()];
            const newId = nextSmallOrgId++;
            
            const baseName = keys.small_org_name_placeholder.includes('(') 
                ? keys.small_org_name_placeholder.split('(')[0].trim() 
                : keys.small_org_name_placeholder.split(' ')[0].trim();
            const defaultName = `${baseName} ${newId % 10}`;

            const newSubOrg = {
                id: newId,
                name: nameOverride || defaultName, 
                weightedAverageScore: 0, 
                participants: []
            };
            org.smallOrgs.push(newSubOrg);
            
            if (addParticipantFlag) {
                addParticipant(orgId, newId);
                renderHierarchy(); 
            }
        }

        function removeSmallOrganization(orgId, subOrgId) {
            const org = largeOrgs.find(o => o.id === orgId);
            if (org) {
                org.smallOrgs = org.smallOrgs.filter(sub => sub.id !== subOrgId);
                renderHierarchy();
                calculateContributions();
            }
        }
        
        function updateSmallOrgData(orgId, subOrgId, key, value) {
            const org = largeOrgs.find(o => o.id === orgId);
            const subOrg = org?.smallOrgs.find(s => s.id === subOrgId);
            if (subOrg) { subOrg[key] = value; }
            if (key === 'name') return;
            renderHierarchy();
        }

        function addParticipant(orgId, subOrgId) {
            const org = largeOrgs.find(o => o.id === orgId);
            const subOrg = org?.smallOrgs.find(s => s.id === subOrgId);
            if (!subOrg) return;

            const keys = translations[getLang()];
            const newId = nextParticipantId++;
            
            const baseName = keys.participant_name_placeholder.includes('(') 
                ? keys.participant_name_placeholder.split('(')[0].trim() 
                : keys.participant_name_placeholder.split(' ')[0].trim();
            const defaultName = `${baseName} ${newId % 100}`;
            
            const newParticipant = {
                id: newId,
                name: defaultName,
                scarcity: 0, 
                causality: 0, 
                breakthrough: 0
            };
            subOrg.participants.push(newParticipant);
            renderHierarchy();
        }

        function removeParticipant(orgId, subOrgId, participantId) {
            const org = largeOrgs.find(o => o.id === orgId);
            const subOrg = org?.smallOrgs.find(s => s.id === subOrgId);
            if (subOrg) {
                subOrg.participants = subOrg.participants.filter(p => p.id !== participantId);
                renderHierarchy();
                calculateContributions();
            }
        }
        
        function updateParticipantData(orgId, subOrgId, participantId, key, value) {
            const org = largeOrgs.find(o => o.id === orgId);
            const subOrg = org?.smallOrgs.find(s => s.id === subOrgId);
            const participant = subOrg?.participants.find(p => p.id === participantId);
            if (participant) {
                if (key === 'name') {
                    participant[key] = value;
                    return; 
                } else {
                    participant[key] = parseInt(value);
                }
            }
            renderHierarchy(); 
        }

        // --- Calculation Helpers ---

        function getParticipantRawScore(p) {
            if (calculationMode === 'multiply') {
                return p.scarcity * p.causality * p.breakthrough;
            } else {
                return p.scarcity + p.causality + p.breakthrough;
            }
        }

        function getParticipantSquaredContribution(p) {
            const rawScore = getParticipantRawScore(p);
            return rawScore * rawScore; 
        }

        function isParticipantInputValid(p) {
             return p.scarcity > 0 && p.causality > 0 && p.breakthrough > 0;
        }

        // --- Intermediate Calculation Logic ---

        function calculateSmallOrgScore(orgId, subOrgId) {
            const org = largeOrgs.find(o => o.id === orgId);
            const smallOrg = org?.smallOrgs.find(s => s.id === subOrgId);
            const scoreDisplay = document.getElementById(`small-org-score-display-${subOrgId}`);
            const keys = translations[getLang()];

            if (!smallOrg || !scoreDisplay) return 0;

            let sumOfSquaredScores = 0; // Numerator
            let sumOfRawScores = 0;     // Denominator

            const hasInvalidInput = smallOrg.participants.some(p => !isParticipantInputValid(p));

            if (smallOrg.participants.length === 0 || hasInvalidInput) {
                smallOrg.weightedAverageScore = 0;
                // Use only the label base for error messages
                scoreDisplay.innerHTML = `<span class="text-red-500 text-sm">${keys.small_org_score_label.split(':')[0]} 0.00 (${keys.invalid_input})</span>`;
                return 0;
            }

            for (const p of smallOrg.participants) {
                const rawScore = getParticipantRawScore(p);
                sumOfSquaredScores += rawScore * rawScore; 
                sumOfRawScores += rawScore;           
            }
            
            if (sumOfRawScores === 0) {
                smallOrg.weightedAverageScore = 0;
                // Use only the label base for error messages
                scoreDisplay.innerHTML = `<span class="text-red-500 text-sm">${keys.small_org_score_label.split(':')[0]} 0.00 (${keys.invalid_input})</span>`;
                return 0;
            }

            const smallOrgWeightedAverage = sumOfSquaredScores / sumOfRawScores;
            smallOrg.weightedAverageScore = smallOrgWeightedAverage;
            
            scoreDisplay.innerHTML = `<span class="text-sm font-semibold text-emerald-700">${keys.small_org_score_label} ${smallOrgWeightedAverage.toFixed(2)}</span>`;
            return smallOrgWeightedAverage;
        }

        function calculateLargeOrgScore(orgId) {
            const largeOrg = largeOrgs.find(o => o.id === orgId);
            const scoreDisplay = document.getElementById(`large-org-score-display-${orgId}`);
            const keys = translations[getLang()];

            if (!largeOrg || !scoreDisplay) return 0;

            let sumOfSquaredAverages = 0;
            let sumOfAverages = 0;       
            let allSmallOrgsValid = true;

            if (largeOrg.smallOrgs.length === 0) {
                 largeOrg.weightedAverageScore = 0;
                 // Use only the label base for error messages
                scoreDisplay.innerHTML = `<span class="text-red-500 text-base">${keys.large_org_score_label.split(':')[0]} 0.00 (${keys.invalid_input})</span>`;
                return 0;
            }
            
            for (const smallOrg of largeOrg.smallOrgs) {
                const smallOrgAverageScore = calculateSmallOrgScore(orgId, smallOrg.id); 
                
                if (smallOrgAverageScore === 0) {
                    allSmallOrgsValid = false;
                    break;
                }
                
                sumOfSquaredAverages += smallOrgAverageScore * smallOrgAverageScore;
                sumOfAverages += smallOrgAverageScore;                            
            }
            
            if (!allSmallOrgsValid || sumOfAverages === 0) {
                largeOrg.weightedAverageScore = 0;
                // Use only the label base for error messages
                scoreDisplay.innerHTML = `<span class="text-red-500 text-base">${keys.large_org_score_label.split(':')[0]} 0.00 (${keys.invalid_input})</span>`;
                return 0;
            }

            const largeOrgWeightedAverage = sumOfSquaredAverages / sumOfAverages;
            largeOrg.weightedAverageScore = largeOrgWeightedAverage;
            
            scoreDisplay.innerHTML = `<span class="text-base font-bold text-blue-700">${keys.large_org_score_label} ${largeOrgWeightedAverage.toFixed(2)}</span>`;
            return largeOrgWeightedAverage;
        }
        
        // --- Full Top-Down Allocation (Main Button) ---

        function calculateContributions() {
            const resultsContainer = document.getElementById('resultsContainer');
            const largeOrgResults = document.getElementById('largeOrgResults');
            const participantResults = document.getElementById('participantResults');
            const participantAggregatedResults = document.getElementById('participantAggregatedResults');
            const errorBox = document.getElementById('errorBox');
            const keys = translations[getLang()];
            
            // 1. Full Validation & Calculation Pass
            let grandTotalAverageScore = 0;
            const calculatedOrgs = [];
            let isValid = largeOrgs.length >= 2;

            for (const largeOrg of largeOrgs) {
                const largeOrgAverageScore = calculateLargeOrgScore(largeOrg.id);
                
                if (largeOrgAverageScore === 0) {
                    isValid = false;
                    break;
                }
                grandTotalAverageScore += largeOrgAverageScore;

                let totalSumOfSquaredParticipantScores = 0;
                largeOrg.smallOrgs.forEach(s => {
                    s.participants.forEach(p => {
                        if(isParticipantInputValid(p)) {
                             totalSumOfSquaredParticipantScores += getParticipantSquaredContribution(p);
                        }
                    });
                });

                calculatedOrgs.push({
                    ...largeOrg,
                    weightedAverageScore: largeOrgAverageScore,
                    totalSumOfSquaredParticipantScores: totalSumOfSquaredParticipantScores, 
                });
            }

            if (!isValid || grandTotalAverageScore === 0) {
                resultsContainer.classList.add('hidden');
                errorBox.innerHTML = keys.error_message_validation;
                errorBox.classList.remove('hidden');
                return;
            }
            errorBox.classList.add('hidden');

            // 2. Final Proportional Allocation
            const finalResults = [];
            const finalOrgRatios = [];
            
            // Get the base score label without the colon for display in parentheses
            const scoreLabelBase = keys.large_org_score_label.endsWith(':') 
                ? keys.large_org_score_label.slice(0, -1) 
                : keys.large_org_score_label;

            const currentLang = getLang();

            for (const largeOrg of calculatedOrgs) {
                const largeOrgRatio = (largeOrg.weightedAverageScore / grandTotalAverageScore) * 100;
                finalOrgRatios.push({ name: largeOrg.name, ratio: largeOrgRatio, score: largeOrg.weightedAverageScore });

                largeOrg.smallOrgs.forEach(smallOrg => {
                    smallOrg.participants.forEach(participant => {
                        if(isParticipantInputValid(participant)) {
                            const pSquaredContribution = getParticipantSquaredContribution(participant);

                            let participantRatio = 0;
                            if (largeOrg.totalSumOfSquaredParticipantScores > 0) {
                                participantRatio = largeOrgRatio * (pSquaredContribution / largeOrg.totalSumOfSquaredParticipantScores);
                            }
                            
                            finalResults.push({
                                largeOrgName: largeOrg.name,
                                smallOrgName: smallOrg.name,
                                name: participant.name,
                                finalRatio: participantRatio
                            });
                        }
                    });
                });
            }

            // 3. Display Results
            finalResults.sort((a, b) => b.finalRatio - a.finalRatio);
            
            
            let orgHtml = finalOrgRatios.map(org => {
                // Now uses the full stored name: Organization (组织) or 组织 (Organization)
                const displayName = getDisplayableName(org.name, currentLang); 

                return `
                    <div class="flex justify-between border-b border-gray-300 pb-1 last:border-b-0">
                        <span class="text-sm text-secondary font-medium">${displayName} (${scoreLabelBase}: ${org.score.toFixed(2)})</span>
                        <span class="text-lg font-bold text-blue-600">${org.ratio.toFixed(2)}%</span>
                    </div>
                `;
            }).join('');
            largeOrgResults.innerHTML = orgHtml;

            let participantHtml = finalResults.map(p => {
                // Now uses the full stored names in the detail view: Organization (组织) / Data Curation (数据管理)
                const largeOrgDisplayName = getDisplayableName(p.largeOrgName, currentLang);
                const smallOrgDisplayName = getDisplayableName(p.smallOrgName, currentLang);

                return `
                    <div class="border-b border-gray-200 pb-1 last:border-b-0">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-800 font-medium">${p.name}</span>
                            <span class="text-md font-bold text-primary">${p.finalRatio.toFixed(2)}%</span>
                        </div>
                        <p class="text-xs text-gray-500 italic">(${largeOrgDisplayName} / ${smallOrgDisplayName})</p>
                    </div>
                `;
            }).join('');
            participantResults.innerHTML = participantHtml;

            const aggregatedMap = {};
            finalResults.forEach(item => {
                const normName = item.name.trim();
                if (aggregatedMap[normName]) {
                    aggregatedMap[normName] += item.finalRatio;
                } else {
                    aggregatedMap[normName] = item.finalRatio;
                }
            });

            const aggregatedResults = Object.keys(aggregatedMap).map(name => ({
                name: name,
                totalRatio: aggregatedMap[name]
            })).sort((a, b) => b.totalRatio - a.totalRatio);

            let aggregatedHtml = aggregatedResults.map(p => `
                <div class="flex justify-between items-center border-b border-blue-200 pb-2 last:border-b-0 py-1">
                    <span class="text-base text-gray-900 font-bold">${p.name}</span>
                    <span class="text-lg font-bold text-emerald-600">${p.totalRatio.toFixed(2)}%</span>
                </div>
            `).join('');
            participantAggregatedResults.innerHTML = aggregatedHtml;

            resultsContainer.classList.remove('hidden');
        }

        // --- Utility and Initialization ---
        
        function setLanguage(lang) {
            const elements = document.querySelectorAll('[data-key]');
            const keys = translations[lang];

            elements.forEach(element => {
                const key = element.getAttribute('data-key');
                if (keys && keys[key]) {
                    if (element.tagName === 'TITLE') {
                        document.title = keys[key];
                    } else if (element.tagName === 'INPUT' && element.placeholder) {
                        // Placeholders should be set correctly from translations
                        element.placeholder = keys[key];
                    } else if (element.tagName === 'BUTTON') {
                        element.textContent = keys[key];
                    } else if (element.tagName !== 'INPUT' && element.tagName !== 'TEXTAREA') {
                        element.textContent = keys[key];
                    }
                }
            });
            
            // Re-render hierarchy to apply the new language formatting to input values
            renderHierarchy(); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            const selector = document.getElementById('language-selector');
            const currentLang = selector.value || 'zh';

            // Select the correct default structure based on language
            const initialStructure = currentLang === 'en' ? hierarchyStructureEN : hierarchyStructureZH;

            // Initial setup: Add the predefined hierarchical structure
            if (largeOrgs.length === 0) {
                for (const largeOrgName in initialStructure) {
                    if (Object.hasOwnProperty.call(initialStructure, largeOrgName)) {
                        const smallOrgNames = initialStructure[largeOrgName];
                        addLargeOrganization(largeOrgName, smallOrgNames); 
                    }
                }
            }

            selector.addEventListener('change', (event) => {
                // To force re-render with new language strings, we must clear and reload data
                const newLang = event.target.value;
                const newStructure = newLang === 'en' ? hierarchyStructureEN : hierarchyStructureZH;
                
                // Reset everything to reload defaults in the correct language format
                largeOrgs = [];
                nextLargeOrgId = 1;
                nextSmallOrgId = 100;
                nextParticipantId = 1000;
                
                for (const largeOrgName in newStructure) {
                    if (Object.hasOwnProperty.call(newStructure, largeOrgName)) {
                        const smallOrgNames = newStructure[largeOrgName];
                        addLargeOrganization(largeOrgName, smallOrgNames); 
                    }
                }
                
                setLanguage(newLang); // Re-render and set text
            });
            
            // Set initial language and render
            setLanguage(currentLang);
            
            // Run initial calculation
            largeOrgs.forEach(org => {
                org.smallOrgs.forEach(sub => calculateSmallOrgScore(org.id, sub.id));
                calculateLargeOrgScore(org.id);
            });
            calculateContributions(); 
        });
    </script>
    
    <footer class="mt-16 w-full max-w-5xl border-t pt-8 text-center text-secondary text-sm">
        <p data-lang-cn="&copy; 2025 QuIReC. All rights reserved. Thanks for the assist and support by the Google Gemini large language model for the development of this website." data-lang-en="&copy; 2025 QuIReC. All rights reserved. Thanks for the assist and support by the Google Gemini large language model for the development of this website.">&copy; 2025 QuIReC. All rights reserved. Thanks for the assist and support by the Google Gemini large language model for the development of this website.</p>
    </footer>

</body>
</html>